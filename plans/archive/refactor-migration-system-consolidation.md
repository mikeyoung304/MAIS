# Refactor: Consolidate Migration System to Enterprise-Grade Single Source of Truth

**Created:** 2026-01-23
**Type:** Refactor
**Complexity:** Medium
**Risk:** Low (no production data)

---

## Overview

The MAIS migration system has accumulated technical debt with a hybrid approach (20+ numbered raw SQL files + 3 Prisma migrations). Since we have no production data, this is the perfect time to consolidate to a clean, enterprise-grade single source of truth.

## Problem Statement

### Current State (Technical Debt)

```
server/prisma/migrations/
├── 00_supabase_reset.sql          # Raw SQL (NOT tracked by Prisma)
├── 01_add_webhook_events.sql      # Raw SQL (NOT tracked by Prisma)
├── ...                            # 20+ more raw SQL files
├── 26_add_project_request_version.sql
├── 20251016140827_initial_schema/ # Prisma (tracked)
├── 20260118000000_add_project_hub/ # Prisma (tracked)
└── 20260123171414_baseline_sync/  # Prisma (tracked) - 1300+ lines
```

**Problems:**

1. **Dual tracking systems** - Raw SQL files not in `_prisma_migrations` table
2. **Perpetual drift detection** - Prisma sees 3 migrations but DB has 28+ changes applied
3. **Complexity** - Two patterns to remember (Pattern A vs Pattern B)
4. **Shadow database issues** - Can't use `prisma migrate dev` against Supabase cloud
5. **No migration linting** - Destructive changes can slip through

### Why Now?

- **No production data** = Zero risk of data loss
- **Baseline exists** = `20260123171414_baseline_sync` has complete schema
- **Team knowledge fresh** = Recent debugging of migration issues

---

## Proposed Solution: Prisma-Only with `--create-only`

### Architecture Decision

**Consolidate to Prisma Migrate as the single source of truth**, using `--create-only` flag for custom SQL when needed.

```
server/prisma/migrations/
├── _archived/                     # Historical reference only
│   ├── 00_supabase_reset.sql
│   └── ... (all numbered files)
├── 00000000000000_baseline/       # Fresh baseline from schema.prisma
│   └── migration.sql              # Complete schema DDL
└── (future migrations here)
```

### Why This Approach?

| Criterion               | Hybrid (Current) | Prisma-Only (Proposed) |
| ----------------------- | ---------------- | ---------------------- |
| Single source of truth  | ❌ Two systems   | ✅ One system          |
| Migration tracking      | ❌ Partial       | ✅ Complete            |
| `prisma migrate status` | ❌ Shows drift   | ✅ Accurate            |
| Shadow database         | ❌ Conflicts     | ✅ Works locally       |
| Custom SQL support      | ✅ Native        | ✅ Via `--create-only` |
| Team cognitive load     | ❌ Two patterns  | ✅ One pattern         |
| CI/CD simplicity        | ❌ Custom loops  | ✅ Single command      |

### Handling PostgreSQL Features

Prisma's `--create-only` flag allows customizing migrations before applying:

```bash
# Generate migration without applying
npx prisma migrate dev --create-only --name add_booking_enum

# Edit prisma/migrations/TIMESTAMP_add_booking_enum/migration.sql
# Add custom SQL for enums, RLS, indexes, etc.

# Apply the customized migration
npx prisma migrate dev
```

**Example custom additions:**

```sql
-- Auto-generated by Prisma (tables, columns)
CREATE TABLE "Booking" (...);

-- Custom additions (enums, RLS, indexes)
CREATE TYPE "BookingType" AS ENUM ('DATE', 'TIMESLOT');
ALTER TABLE "Booking" ENABLE ROW LEVEL SECURITY;
CREATE INDEX CONCURRENTLY idx_booking_tenant_date ON "Booking" (tenant_id, date);
```

---

## Technical Approach

### Phase 1: Clean Slate (30 minutes)

**Goal:** Reset database and migration history to pristine state.

#### Step 1.1: Archive Historical Migrations

```bash
cd server/prisma/migrations

# Create archive directory
mkdir -p _archived

# Move all numbered SQL files
mv [0-9][0-9]*.sql _archived/
mv [0-9][0-9][a-z]*.sql _archived/ 2>/dev/null || true

# Move old Prisma migrations
mv 20251016140827_initial_schema _archived/
mv 20260118000000_add_project_hub _archived/
mv 20260123171414_baseline_sync _archived/
```

#### Step 1.2: Reset Database

```bash
# Drop and recreate database (Supabase)
# Option A: Via Supabase Dashboard > Settings > Database > Reset
# Option B: Via SQL
psql $DATABASE_URL -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"

# Or if using local Docker:
docker compose down -v && docker compose up -d
```

#### Step 1.3: Create Fresh Baseline

```bash
# Verify schema.prisma is correct (it should be - it's our source of truth)
npx prisma validate

# Create baseline migration from current schema
npx prisma migrate dev --name baseline

# This creates: migrations/TIMESTAMP_baseline/migration.sql
# And applies it to the database
```

### Phase 2: Add Enterprise Tooling (1 hour)

**Goal:** Add linting, validation, and CI/CD improvements.

#### Step 2.1: Add Atlas for Migration Linting

Atlas provides 50+ automated checks for migration safety.

```bash
# Install Atlas
brew install ariga/tap/atlas  # macOS
# or: curl -sSf https://atlasgo.io/install.sh | sh
```

Create `server/atlas.hcl`:

```hcl
data "external_schema" "prisma" {
  program = [
    "npx",
    "prisma",
    "migrate",
    "diff",
    "--from-empty",
    "--to-schema-datamodel",
    "prisma/schema.prisma",
    "--script"
  ]
}

env "local" {
  src = data.external_schema.prisma.url
  dev = "docker://postgres/15/dev?search_path=public"

  migration {
    dir = "file://prisma/migrations"
  }
}

lint {
  destructive {
    error = true  # Block destructive changes
  }

  data_depend {
    error = true  # Detect data-dependent changes
  }
}
```

#### Step 2.2: Update CI/CD Pipeline

Create `.github/workflows/migration-validation.yml`:

```yaml
name: Migration Validation

on:
  pull_request:
    paths:
      - 'server/prisma/**'
  push:
    branches: [main]
    paths:
      - 'server/prisma/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate Prisma schema
        run: npx prisma validate
        working-directory: server

      - name: Check migration status
        run: npx prisma migrate status
        working-directory: server
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test

      - name: Apply migrations to test DB
        run: npx prisma migrate deploy
        working-directory: server
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test

      - name: Generate Prisma Client
        run: npx prisma generate
        working-directory: server

      - name: Type check
        run: npm run typecheck
        working-directory: server

  lint-migrations:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Atlas
        uses: ariga/setup-atlas@v0

      - name: Lint migrations
        uses: ariga/atlas-action/migrate/lint@v1
        with:
          dir: 'file://server/prisma/migrations'
          dev-url: 'docker://postgres/15/dev?search_path=public'
```

#### Step 2.3: Add Pre-Commit Hook

Update `.husky/pre-commit` or create `server/.husky/pre-commit`:

```bash
#!/bin/bash

# Validate Prisma schema before commit
cd server
npx prisma validate || {
  echo "❌ Prisma schema validation failed"
  exit 1
}

# Check for empty migration directories
for dir in prisma/migrations/*/; do
  if [ -d "$dir" ] && [ ! -f "${dir}migration.sql" ]; then
    echo "❌ Empty migration directory: $dir"
    echo "Run: npx prisma migrate dev --name <name>"
    exit 1
  fi
done

echo "✅ Migration checks passed"
```

### Phase 3: Update Documentation (30 minutes)

**Goal:** Single, clear migration pattern for the team.

#### Step 3.1: Update CLAUDE.md

Replace the dual-pattern documentation with:

```markdown
## Database Migrations

### Single Pattern: Prisma Migrate

All database changes go through Prisma Migrate:

\`\`\`bash

# Standard migration (tables, columns, constraints)

npx prisma migrate dev --name descriptive_name

# Custom SQL migration (enums, RLS, indexes, extensions)

npx prisma migrate dev --create-only --name descriptive_name

# Edit migrations/TIMESTAMP_descriptive_name/migration.sql

# Add your custom SQL

npx prisma migrate dev
\`\`\`

### Examples

**Adding a column:**
\`\`\`bash

# 1. Edit schema.prisma

# 2. Run migration

npx prisma migrate dev --name add_booking_notes
\`\`\`

**Adding an enum:**
\`\`\`bash

# 1. Add enum to schema.prisma

enum BookingStatus {
PENDING
CONFIRMED
CANCELLED
}

# 2. Create migration without applying

npx prisma migrate dev --create-only --name add_booking_status

# 3. Edit migration.sql if needed (Prisma handles enums well now)

# 4. Apply

npx prisma migrate dev
\`\`\`

**Adding RLS policy:**
\`\`\`bash

# 1. Create migration

npx prisma migrate dev --create-only --name add_booking_rls

# 2. Edit migration.sql, add:

ALTER TABLE "Booking" ENABLE ROW LEVEL SECURITY;
CREATE POLICY tenant_isolation ON "Booking"
USING (tenant_id = current_setting('app.tenant_id')::text);

# 3. Apply

npx prisma migrate dev
\`\`\`

### CI/CD

Migrations are automatically:

- Validated in PR checks
- Linted for destructive changes (Atlas)
- Applied to staging on merge
- Applied to production on release

### Never Do

- ❌ Create raw SQL files outside Prisma migrations
- ❌ Run \`prisma migrate reset\` in production
- ❌ Edit migrations after they're committed
- ❌ Skip the \`--create-only\` step for custom SQL
```

#### Step 3.2: Create Migration Guide

Create `server/prisma/migrations/README.md`:

```markdown
# MAIS Database Migrations

## Quick Start

\`\`\`bash

# Create and apply a migration

npx prisma migrate dev --name your_change_description
\`\`\`

## For Custom SQL (Enums, RLS, Indexes)

\`\`\`bash

# 1. Generate migration without applying

npx prisma migrate dev --create-only --name your_change_description

# 2. Edit the generated migration.sql

# 3. Apply the migration

npx prisma migrate dev
\`\`\`

## Migration History

| Migration | Description                                    | Date       |
| --------- | ---------------------------------------------- | ---------- |
| baseline  | Initial schema with all tables, enums, indexes | 2026-01-23 |

## Archived Migrations

Historical migrations from the previous hybrid system are in \`\_archived/\`.
These are for reference only and should not be modified or re-applied.

## CI/CD

- **PR Checks:** Schema validation, migration status, type checking
- **Atlas Linting:** Destructive change detection
- **Deploy:** \`prisma migrate deploy\` (applies pending migrations)
```

---

## Acceptance Criteria

### Functional Requirements

- [ ] All historical migrations archived in `_archived/` directory
- [ ] Fresh baseline migration created from `schema.prisma`
- [ ] Database schema matches `schema.prisma` exactly
- [ ] `npx prisma migrate status` shows no pending migrations
- [ ] `npx prisma migrate status` shows no drift

### Non-Functional Requirements

- [ ] CI workflow validates migrations on every PR
- [ ] Atlas linting blocks destructive changes
- [ ] Pre-commit hook validates schema
- [ ] Documentation updated in CLAUDE.md
- [ ] Migration README created

### Quality Gates

- [ ] All existing tests pass
- [ ] TypeScript compilation succeeds
- [ ] Prisma Client generates without errors
- [ ] Local development workflow verified

---

## Success Metrics

| Metric                       | Before        | After         |
| ---------------------------- | ------------- | ------------- |
| Migration files tracked      | 3 of 31 (10%) | 100%          |
| `migrate status` accuracy    | Shows drift   | Accurate      |
| Patterns to remember         | 2             | 1             |
| CI migration validation      | Manual        | Automated     |
| Destructive change detection | None          | Atlas linting |

---

## Risk Analysis & Mitigation

| Risk                        | Likelihood | Impact | Mitigation                                       |
| --------------------------- | ---------- | ------ | ------------------------------------------------ |
| Schema mismatch after reset | Low        | Medium | Validate with `prisma validate` before and after |
| Missing enum/index          | Low        | Low    | Compare archived SQL with new baseline           |
| Team confusion              | Low        | Low    | Clear documentation, team walkthrough            |
| CI/CD breaks                | Low        | Medium | Test workflow on branch before merge             |

---

## Implementation Checklist

### Phase 1: Clean Slate

- [ ] Create `_archived/` directory
- [ ] Move numbered SQL files (00-26) to archive
- [ ] Move old Prisma migrations to archive
- [ ] Reset database (drop/recreate schema)
- [ ] Run `npx prisma migrate dev --name baseline`
- [ ] Verify `npx prisma migrate status` is clean

### Phase 2: Enterprise Tooling

- [ ] Install Atlas CLI
- [ ] Create `server/atlas.hcl` config
- [ ] Create `.github/workflows/migration-validation.yml`
- [ ] Update pre-commit hook
- [ ] Test CI workflow on feature branch

### Phase 3: Documentation

- [ ] Update CLAUDE.md migration section
- [ ] Create `server/prisma/migrations/README.md`
- [ ] Update `docs/solutions/SCHEMA_DRIFT_PREVENTION.md`
- [ ] Archive or update related solution docs

### Phase 4: Verification

- [ ] Run full test suite
- [ ] Run `npm run typecheck`
- [ ] Test local development workflow
- [ ] Verify Prisma Studio works
- [ ] Test `--create-only` workflow for custom SQL

---

## References

### Internal

- `server/prisma/schema.prisma` - Source of truth for schema
- `docs/solutions/SCHEMA_DRIFT_PREVENTION.md` - Historical context
- `CLAUDE.md` - Team documentation

### External

- [Prisma Migrate Documentation](https://www.prisma.io/docs/orm/prisma-migrate)
- [Customizing Migrations](https://www.prisma.io/docs/orm/prisma-migrate/workflows/customizing-migrations)
- [Atlas Migration Linting](https://atlasgo.io/versioned/lint)
- [Atlas + Prisma Integration](https://atlasgo.io/guides/orms/prisma)

---

## Diagram: Before vs After

```
BEFORE (Hybrid - Technical Debt)
================================
schema.prisma ──┬──> Prisma Migrate ──> _prisma_migrations (3 entries)
                │
                └──> Raw SQL Files ──> Database (28 changes, untracked)

                Result: Perpetual drift, two patterns, complexity


AFTER (Consolidated - Enterprise-Grade)
=======================================
schema.prisma ──> Prisma Migrate ──> _prisma_migrations (all tracked)
                       │
                       └──> Atlas Lint ──> CI/CD validation

                Result: Single source of truth, one pattern, automated safety
```

---

**Estimated Time:** 2-3 hours
**Complexity:** Medium (mostly file organization and CI setup)
**Risk Level:** Low (no production data)
