---
status: complete
priority: p1
issue_id: "274"
tags: [code-review, security, jwt, secrets, authentication]
dependencies: []
completed_date: 2025-12-05
---

# JWT Secret Reuse Between Auth and Booking Tokens

## Problem Statement

Booking management tokens fall back to `JWT_SECRET` when `BOOKING_TOKEN_SECRET` is not set. This creates key isolation failure where a tenant admin breach can lead to forged booking tokens.

**Why it matters:**
- If `JWT_SECRET` is compromised (tenant admin breach), attackers can forge booking tokens
- No key isolation between admin sessions and customer self-service
- Rotating `JWT_SECRET` invalidates all booking management links sent to customers

## Findings

### Agent: security-sentinel
- **Location:** `server/src/lib/booking-tokens.ts:71`, `server/src/lib/core/config.ts:61`
- **Evidence:**
```typescript
export function getBookingTokenSecret(config: Config): string {
  return config.BOOKING_TOKEN_SECRET || config.JWT_SECRET;
}
```
- **Severity:** HIGH - Privilege escalation, unauthorized booking modifications

## Proposed Solutions

### Option A: Require BOOKING_TOKEN_SECRET in Production (Recommended)
**Description:** Make `BOOKING_TOKEN_SECRET` required with fail-fast validation

```typescript
// lib/booking-tokens.ts
export function getBookingTokenSecret(config: Config): string {
  if (!config.BOOKING_TOKEN_SECRET) {
    throw new Error('BOOKING_TOKEN_SECRET is required for production. Generate with: openssl rand -hex 32');
  }
  return config.BOOKING_TOKEN_SECRET;
}

// lib/core/config.ts
BOOKING_TOKEN_SECRET: z.string().min(32).describe('Required for booking management tokens'),
```

**Pros:**
- Fail-fast prevents production deployment without secret
- Clear error message with generation command
- Separates concerns completely

**Cons:**
- Breaking change for existing deployments (minor - update .env)

**Effort:** Small (15 minutes)
**Risk:** Low

### Option B: Derive Booking Secret from JWT_SECRET
**Description:** Use HKDF to derive booking secret from main secret

**Effort:** Medium (1 hour)
**Risk:** Low (but still single point of failure)

## Recommended Action

Implement Option A immediately. Update deployment documentation.

## Technical Details

**Affected Files:**
- `server/src/lib/booking-tokens.ts`
- `server/src/lib/core/config.ts`
- `.env.example` (add BOOKING_TOKEN_SECRET)
- Deployment documentation

**Environment Setup:**
```bash
# Generate new booking token secret
openssl rand -hex 32

# Add to .env
BOOKING_TOKEN_SECRET=<generated_value>
```

## Acceptance Criteria

- [x] `BOOKING_TOKEN_SECRET` required in config schema
- [x] Application fails to start without valid secret (min 32 chars enforced by Zod)
- [x] Error message includes generation command
- [x] `.env.example` updated with placeholder and security note
- [x] Both root and server .env files updated with generated secret
- [x] Comprehensive test suite added (35 tests covering security, validation, and state management)

## Work Log

| Date | Action | Learnings |
|------|--------|-----------|
| 2025-12-05 | Created from security review | Critical before production |
| 2025-12-05 | Implemented Option A | Config validation enforces separation, fail-fast design prevents deployment without proper secrets |
| 2025-12-05 | Added comprehensive tests | 35 tests pass including security isolation, token validation, and state management scenarios |

## Resources

- Related: `server/src/lib/booking-tokens.ts`
- Related: `server/src/lib/core/config.ts`
