---
status: pending
priority: p1
issue_id: 5242
tags: [code-review, security, pr-44]
dependencies: []
---

# Health Routes Timing Attack Vulnerability

## Problem Statement

`internal-agent-health.routes.ts` reimplements the `verifyInternalSecret` middleware instead of importing from `internal-agent-shared.ts`, using a **non-timing-safe comparison** (`secret !== expectedSecret`) that allows timing attacks to discover the internal API secret.

**Why this matters:** An attacker can measure response times to guess the secret character-by-character. The shared module uses `timingSafeCompare()` to prevent this, but the health routes don't use it.

**Impact:** P1 CRITICAL - Security vulnerability that allows unauthorized access to internal agent endpoints.

## Findings

### Security Sentinel Review

**File:** `server/src/routes/internal-agent-health.routes.ts:94`
**Issue:** Simple string comparison instead of timing-safe comparison

```typescript
// VULNERABLE (current)
const secret = req.headers['x-internal-secret'] as string | undefined;
const expectedSecret = internalApiSecret;
if (!secret || secret !== expectedSecret) {
  return res.status(401).json({ error: 'Unauthorized' });
}

// CORRECT (shared module pattern)
import { verifyInternalSecret } from './internal-agent-shared';
router.use(verifyInternalSecret(internalApiSecret));
```

### Code Simplicity Review

**File:** `server/src/routes/internal-agent-health.routes.ts:80-103`
**Issue:** 80 lines of duplicated auth middleware logic

- Different log messages than shared version
- Inline middleware instead of factory function
- Missing timing-safe comparison

**Root cause:** Health routes file created before shared module existed, never migrated.

## Proposed Solutions

### Solution 1: Import Shared Middleware (RECOMMENDED)

**Pros:**

- Fixes timing attack vulnerability
- Eliminates 80 lines of duplicate code
- Consistent auth pattern across all routes
  **Cons:** None
  **Effort:** Small (15 minutes)
  **Risk:** Very Low - shared module already battle-tested in 5 other route files

**Implementation:**

```typescript
// server/src/routes/internal-agent-health.routes.ts
import { verifyInternalSecret } from './internal-agent-shared';

export function createInternalAgentHealthRoutes(internalApiSecret?: string): Router {
  const router = Router();

  // Replace lines 80-103 with:
  router.use(verifyInternalSecret(internalApiSecret));

  // ... rest of routes ...
}
```

### Solution 2: Fix Local Implementation

**Pros:**

- Keeps health routes independent
  **Cons:**
- Maintains duplicate code (80 LOC)
- Still need to remember to update both places
- Violates DRY principle
  **Effort:** Small (10 minutes)
  **Risk:** Low

**Implementation:**

```typescript
// Add timingSafeCompare() to local middleware
import { timingSafeEqual } from 'crypto';

if (!secret || !timingSafeEqual(Buffer.from(secret), Buffer.from(expectedSecret))) {
  return res.status(401).json({ error: 'Unauthorized' });
}
```

## Recommended Action

**Use Solution 1** - Import shared middleware. This is the only solution that addresses BOTH the security vulnerability AND the code duplication.

## Technical Details

**Affected Files:**

- `server/src/routes/internal-agent-health.routes.ts` (vulnerable implementation)
- `server/src/routes/internal-agent-shared.ts` (correct implementation)

**Security References:**

- OWASP: [Timing Attack](https://owasp.org/www-community/attacks/Timing_attack)
- CLAUDE.md Pitfall #58: Email-based auth on sensitive routes
- CLAUDE.md Security Rules: Rate limit auth endpoints

**Related Endpoints:**

- `/v1/internal/agent/health` (only endpoint in health routes)

## Acceptance Criteria

- [ ] Health routes import `verifyInternalSecret` from shared module
- [ ] Local middleware implementation deleted (lines 80-103)
- [ ] Health endpoint still returns 401 for missing/invalid secret
- [ ] Health endpoint still returns 503 if secret not configured
- [ ] `npm run --workspace=server typecheck` passes
- [ ] Security Sentinel review finds no timing attack vulnerabilities

## Work Log

**2026-02-09 - Initial Assessment (Code Review PR #44)**

- Security Sentinel identified timing attack vulnerability
- Code Simplicity Review identified 80 LOC duplication
- Confirmed shared module has correct timing-safe implementation
- Created todo for immediate fix before merge

## Resources

- **PR:** https://github.com/mikeyoung304/MAIS/pull/44
- **Related Files:**
  - `server/src/routes/internal-agent-shared.ts:56-70` (correct implementation)
  - `server/src/routes/internal-agent-health.routes.ts:80-103` (vulnerable code)
- **Prevention Pattern:** `docs/solutions/security-issues/P1-SECURITY-PREVENTION-STRATEGIES.md`
