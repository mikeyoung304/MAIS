---
status: complete
priority: p1
issue_id: '063'
tags: [code-review, security, file-upload, validation]
dependencies: []
---

# MIME Type Validation Can Be Bypassed (Magic Number Check Missing)

## Problem Statement

The file upload validation relies solely on client-provided MIME type without verifying actual file contents. An attacker can upload malicious files (PHP shells, executables, polyglot files) by setting a fake `Content-Type: image/jpeg` header.

**Why This Matters:**

- Potential for malicious file uploads disguised as images
- XSS vulnerabilities via SVG files (if added to allowlist)
- In filesystem mode, could lead to code execution if files are served incorrectly
- Compliance violations for secure file handling

## Findings

### Evidence from Code Review

**Location:** `server/src/services/upload.service.ts` lines 95-108

```typescript
// Current implementation - trusts client-provided mimetype
private validateFile(file: UploadedFile, maxSizeMB?: number): void {
  // Check mime type
  if (!this.allowedMimeTypes.includes(file.mimetype)) {
    throw new Error(
      `Invalid file type. Allowed types: ${this.allowedMimeTypes.join(', ')}`
    );
  }
  // ... no content-based validation
}
```

**Attack Vector:**

```bash
# Attacker uploads malicious PHP shell disguised as image
curl -X POST \
  -H "Authorization: Bearer $TOKEN" \
  -F "file=@webshell.php;type=image/jpeg" \
  https://api.example.com/v1/tenant-admin/segment-image
```

### Security Impact

- **Security Sentinel**: HIGH - MIME type spoofing allows malicious file upload
- Upload of executable/script files could lead to RCE in certain configurations
- Polyglot files (valid image + embedded script) bypass simple MIME checks

## Proposed Solutions

### Option A: Magic Number Validation with file-type Package (Recommended)

**Description:** Use the `file-type` package to detect actual file content based on magic bytes.

**Pros:**

- Industry-standard approach
- Catches 99%+ of spoofing attempts
- Fast (only reads first few bytes)
- Actively maintained package

**Cons:**

- New dependency
- Async validation (minor refactor)
- Some edge cases with polyglot files

**Effort:** Small (1 hour)
**Risk:** Low

```bash
npm install file-type --workspace=server
```

```typescript
import { fileTypeFromBuffer } from 'file-type';

private async validateFile(file: UploadedFile, maxSizeMB?: number): Promise<void> {
  // 1. Check declared MIME type
  if (!this.allowedMimeTypes.includes(file.mimetype)) {
    throw new Error(`Invalid file type: ${file.mimetype}`);
  }

  // 2. CRITICAL: Verify actual file content (magic numbers)
  const detectedType = await fileTypeFromBuffer(file.buffer);
  if (!detectedType || !this.allowedMimeTypes.includes(detectedType.mime)) {
    logger.warn(
      { declaredType: file.mimetype, detectedType: detectedType?.mime },
      'MIME type mismatch detected - possible spoofing attempt'
    );
    throw new Error('File content does not match declared type');
  }
}
```

### Option B: Image Processing Validation

**Description:** Use Sharp to actually parse the image, failing if it's not valid.

**Pros:**

- Guarantees file is a real image
- Can also resize/optimize in same step
- Sharp already used elsewhere in many Node.js projects

**Cons:**

- Heavier processing (full parse vs byte check)
- May reject some valid but unusual image formats
- More resource intensive

**Effort:** Medium (2 hours)
**Risk:** Medium - may reject edge cases

### Option C: Combination Approach

**Description:** Magic number check + Sharp validation for extra security.

**Effort:** Medium (2-3 hours)
**Risk:** Low

## Recommended Action

**Option A: Magic Number Validation** - Fast, effective, minimal changes, standard security practice.

## Technical Details

**Affected Files:**

- `server/src/services/upload.service.ts` - Add async validateFile
- `server/src/routes/tenant-admin.routes.ts` - Ensure await on validation
- `server/package.json` - Add file-type dependency
- `server/test/services/upload.service.test.ts` - Add security tests

**Database Changes:** None

## Acceptance Criteria

- [ ] `file-type` package installed
- [ ] `validateFile` checks magic bytes against declared MIME type
- [ ] Mismatch logs warning with both types for security monitoring
- [ ] Test: PHP file with image/jpeg header is rejected
- [ ] Test: Valid JPEG with image/jpeg header is accepted
- [ ] Test: PNG file with image/jpeg header is rejected

## Work Log

| Date       | Action  | Notes                                              |
| ---------- | ------- | -------------------------------------------------- |
| 2025-11-29 | Created | Found during code review - Security Sentinel agent |

## Resources

- file-type package: https://www.npmjs.com/package/file-type
- OWASP File Upload: https://cheatsheetseries.owasp.org/cheatsheets/File_Upload_Cheat_Sheet.html
