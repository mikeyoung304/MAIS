---
status: complete
priority: p1
issue_id: '099'
tags: [code-review, security, ui-redesign]
dependencies: []
---

# CSV Injection Vulnerability in Booking Export

## Problem Statement

The CSV export function in TenantBookingList doesn't sanitize user-controlled data (couple name, email). If a user enters `=CMD|' /C calc'!A1` as their name, Excel will execute arbitrary commands when the CSV is opened.

**Why it matters:** Remote code execution on tenant's machine when they open exported CSV.

## Findings

### From security-sentinel agent:

**File:** `client/src/features/tenant-admin/TenantBookingList.tsx`
**Lines:** 49-70

```typescript
const rows = filteredBookings.map((b) => [
  b.coupleName, // User input - not sanitized
  b.email, // User input - not sanitized
  b.eventDate,
  b.packageId,
  (b as any).status || 'confirmed',
  `$${(b.totalCents / 100).toFixed(2)}`,
]);
```

**Attack Scenario:**

1. Attacker creates booking with couple name: `=1+1+cmd|'/c calc'!A1`
2. Tenant exports bookings to CSV
3. Excel opens and executes the formula, launching calculator (or worse)

## Proposed Solutions

### Solution 1: Sanitize CSV Fields (Recommended)

**Pros:** Simple, effective
**Cons:** Prefixes user data with quote
**Effort:** Small (30 min)
**Risk:** Low

```typescript
const sanitizeCsvField = (field: string): string => {
  if (!field) return '';

  // If field starts with dangerous characters, prefix with single quote
  const dangerousChars = ['=', '+', '-', '@', '\t', '\r'];
  if (dangerousChars.some((char) => field.startsWith(char))) {
    return `'${field}`;
  }

  return field;
};

// In exportToCSV
const rows = filteredBookings.map((b) => [
  sanitizeCsvField(b.coupleName),
  sanitizeCsvField(b.email),
  b.eventDate,
  // ...
]);
```

### Solution 2: Use CSV Library (papaparse)

**Pros:** Handles all edge cases
**Cons:** New dependency
**Effort:** Small
**Risk:** Low

## Recommended Action

Implement Solution 1 for immediate fix, consider Solution 2 for future exports.

## Technical Details

**Affected files:**

- `client/src/features/tenant-admin/TenantBookingList.tsx`

## Acceptance Criteria

- [ ] CSV fields starting with =, +, -, @, \t, \r are prefixed with '
- [ ] Fields containing commas are properly quoted
- [ ] Export still works correctly with sanitization
- [ ] Unit test covers dangerous input scenarios

## Work Log

| Date       | Action                   | Learnings                |
| ---------- | ------------------------ | ------------------------ |
| 2025-11-30 | Created from code review | CSV injection identified |

## Resources

- OWASP CSV Injection: https://owasp.org/www-community/attacks/CSV_Injection
