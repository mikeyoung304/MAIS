name: Deploy AI Agents to Cloud Run

on:
  push:
    branches:
      - main
    paths:
      - 'server/src/agent-v2/deploy/*/src/**'
      - 'server/src/agent-v2/deploy/*/package.json'
      - 'server/src/agent-v2/deploy/*/tsconfig.json'
  workflow_dispatch:
    inputs:
      agent:
        description: 'Agent to deploy (or "all" for all agents)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - concierge
          - marketing
          - storefront
          - research
          - booking
          - project-hub
      force:
        description: 'Force deployment even without changes'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

# Prevent concurrent agent deployments
concurrency:
  group: deploy-agents
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  GOOGLE_CLOUD_PROJECT: handled-484216
  GOOGLE_CLOUD_REGION: us-central1

jobs:
  # Job 1: Detect which agents need deployment
  detect-changes:
    name: Detect Changed Agents
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      agents: ${{ steps.detect.outputs.agents }}
      has_changes: ${{ steps.detect.outputs.has_changes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit for diff

      - name: Detect changed agents
        id: detect
        run: |
          # If manual trigger with specific agent
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.agent }}" = "all" ]; then
              AGENTS='["concierge","marketing","storefront","research","booking","project-hub"]'
            else
              AGENTS='["${{ github.event.inputs.agent }}"]'
            fi
            echo "agents=$AGENTS" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ Manual trigger - deploying: $AGENTS"
            exit 0
          fi

          # Auto-detect changes from git diff
          CHANGED_AGENTS=""

          # Check each agent directory for changes
          for AGENT in concierge marketing storefront research booking project-hub; do
            if git diff --name-only HEAD~1 HEAD | grep -q "server/src/agent-v2/deploy/$AGENT/"; then
              if [ -z "$CHANGED_AGENTS" ]; then
                CHANGED_AGENTS="\"$AGENT\""
              else
                CHANGED_AGENTS="$CHANGED_AGENTS,\"$AGENT\""
              fi
              echo "âœ… Changes detected in: $AGENT"
            fi
          done

          if [ -z "$CHANGED_AGENTS" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "agents=[]" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No agent changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "agents=[$CHANGED_AGENTS]" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ Agents to deploy: [$CHANGED_AGENTS]"
          fi

  # Job 2: Deploy changed agents
  deploy-agent:
    name: Deploy ${{ matrix.agent }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [detect-changes]
    if: needs.detect-changes.outputs.has_changes == 'true'

    strategy:
      matrix:
        agent: ${{ fromJson(needs.detect-changes.outputs.agents) }}
      fail-fast: false  # Deploy other agents even if one fails

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GOOGLE_CLOUD_PROJECT }}

      - name: Verify GCP authentication
        run: |
          echo "ðŸ” Verifying GCP authentication..."
          gcloud auth list
          gcloud config list project

      - name: Install agent dependencies
        run: |
          cd server/src/agent-v2/deploy/${{ matrix.agent }}
          npm install
          echo "âœ… Dependencies installed for ${{ matrix.agent }}"

      - name: Build agent
        run: |
          cd server/src/agent-v2/deploy/${{ matrix.agent }}
          npm run build
          echo "âœ… Build complete for ${{ matrix.agent }}"

      - name: Deploy agent to Cloud Run
        id: deploy
        run: |
          cd server/src/agent-v2/deploy/${{ matrix.agent }}

          echo "ðŸš€ Deploying ${{ matrix.agent }} agent to Cloud Run..."

          # Use ADK to deploy
          npx adk deploy cloud_run \
            --project=${{ env.GOOGLE_CLOUD_PROJECT }} \
            --region=${{ env.GOOGLE_CLOUD_REGION }} \
            --service_name=${{ matrix.agent }}-agent

          echo "âœ… Deployment complete for ${{ matrix.agent }}"

      - name: Get deployment URL
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ matrix.agent }}-agent \
            --region=${{ env.GOOGLE_CLOUD_REGION }} \
            --format='value(status.url)' 2>/dev/null || echo "URL not available")

          echo "ðŸ“ Service URL: $SERVICE_URL"
          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT

      - name: Verify deployment health
        run: |
          echo "ðŸ” Verifying agent health..."

          SERVICE_URL=$(gcloud run services describe ${{ matrix.agent }}-agent \
            --region=${{ env.GOOGLE_CLOUD_REGION }} \
            --format='value(status.url)' 2>/dev/null)

          if [ -z "$SERVICE_URL" ]; then
            echo "âŒ Could not get service URL"
            exit 1
          fi

          # Wait for Cloud Run to stabilize
          sleep 15

          # Check agent health with timeout
          HTTP_STATUS=$(curl -s -o /tmp/health.json -w "%{http_code}" \
            --max-time 30 \
            "$SERVICE_URL/health" || echo "000")

          if [ "$HTTP_STATUS" = "000" ]; then
            echo "âŒ Agent unreachable after deployment"
            exit 1
          elif [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            echo "âœ… Agent healthy (HTTP $HTTP_STATUS)"
            cat /tmp/health.json
          else
            echo "âŒ Agent unhealthy (HTTP $HTTP_STATUS)"
            cat /tmp/health.json 2>/dev/null || true
            exit 1
          fi

  # Job 3: Summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-agent]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# ðŸ¤– Agent Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-changes.outputs.has_changes }}" != "true" ]; then
            echo "â„¹ï¸  No agent changes detected in this push." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "## Deployed Agents" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          AGENTS='${{ needs.detect-changes.outputs.agents }}'
          echo "Agents: $AGENTS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy-agent.result }}" = "success" ]; then
            echo "âœ… **All deployments successful!**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-agent.result }}" = "failure" ]; then
            echo "âŒ **Some deployments failed. Check individual job logs.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  **Deployment status: ${{ needs.deploy-agent.result }}**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Service URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Agent | Cloud Run URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|---------------|" >> $GITHUB_STEP_SUMMARY
          echo "| concierge | https://concierge-agent-506923455711.us-central1.run.app |" >> $GITHUB_STEP_SUMMARY
          echo "| marketing | https://marketing-agent-506923455711.us-central1.run.app |" >> $GITHUB_STEP_SUMMARY
          echo "| storefront | https://storefront-agent-506923455711.us-central1.run.app |" >> $GITHUB_STEP_SUMMARY
          echo "| research | https://research-agent-506923455711.us-central1.run.app |" >> $GITHUB_STEP_SUMMARY
          echo "| booking | https://booking-agent-506923455711.us-central1.run.app |" >> $GITHUB_STEP_SUMMARY
          echo "| project-hub | https://project-hub-agent-506923455711.us-central1.run.app |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "Triggered by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
