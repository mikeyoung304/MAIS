# Plan Review Context: Section Content Migration Phase 5.2

**Date:** 2026-02-02
**Plan File:** `docs/plans/2026-02-02-refactor-section-content-phase-5.2-final-cleanup-plan.md`
**Command:** `/plan_review docs/plans/2026-02-02-refactor-section-content-phase-5.2-final-cleanup-plan.md`

---

## ⚠️ CRITICAL CONTEXT: Pre-Launch Codebase

**NO REAL USERS. NO REAL DATA. NO MIGRATION CONCERNS.**

This is a pre-launch codebase. The ONLY goal is **long-term code quality**.

**What this means for your review:**

- ❌ Don't suggest backward compatibility shims
- ❌ Don't suggest gradual rollouts or feature flags
- ❌ Don't suggest data migration scripts
- ❌ Don't worry about breaking changes for users
- ✅ DO focus on clean architecture
- ✅ DO suggest aggressive deletion of legacy code
- ✅ DO prioritize maintainability over transition safety
- ✅ DO challenge any complexity that only exists for "safety"

If you see code that exists purely for migration/transition purposes, flag it for removal.

---

## Executive Summary

Complete the Section Content Migration by making the `SectionContent` table the single source of truth and dropping legacy `landingPageConfig` JSON columns from the Tenant model.

**Scope:**

- Migrate 8 legacy endpoints from JSON column manipulation to `SectionContentService`
- Add 3 new service methods (`togglePage`, `ensureDefaultSections`, `isPageEnabled`)
- Add response adapter functions to maintain backward compatibility with agent tools
- Update 3 repository methods to stop querying `landingPageConfig` columns
- Drop 3 columns from Prisma schema (`landingPageConfig`, `landingPageConfigDraft`, `landingPageConfigDraftVersion`)

---

## Project Context

### What is MAIS/HANDLED?

MAIS (gethandled.ai) is a membership platform for service professionals (photographers, coaches, therapists). Built as a multi-tenant modular monolith with:

- **Backend:** Express 4, TypeScript 5.9.3 (strict), Prisma 7, PostgreSQL
- **Frontend:** React 18, Next.js 14 App Router, TailwindCSS
- **AI Agents:** Vertex AI + ADK (Agent Development Kit), 3 consolidated agents (customer-agent, tenant-agent, research-agent)

### What is Section Content Migration?

Migrating storefront content from:

- **Before:** Monolithic JSON columns (`Tenant.landingPageConfig`, `Tenant.landingPageConfigDraft`)
- **After:** Normalized `SectionContent` table with per-section rows

**Benefits:**

1. Section-level publishing (publish hero without publishing about)
2. Granular agent operations (CRUD one row, not read/modify/write entire JSON)
3. Version history per section (already in schema)
4. Future A2A (agent-to-agent) - different agents can own different sections

### Current State (Phases 0-5.1 Complete)

| Phase     | Work                                                                | Status |
| --------- | ------------------------------------------------------------------- | ------ |
| Phase 0   | BlockType enum, pageName field, block-type-mapper.ts                | ✅     |
| Phase 1   | SectionContentRepository, SectionContentService (64 tests)          | ✅     |
| Phase 2   | Agent tools: publish_section, discard_section (T3)                  | ✅     |
| Phase 3   | Backend routes for section-level operations                         | ✅     |
| Phase 4   | Frontend migration, PostMessage protocol                            | ✅     |
| Phase 5.0 | /storefront/publish and /storefront/discard → SectionContentService | ✅     |
| Phase 5.1 | Deleted: LandingPageService, legacy routes, 1929 lines removed      | ✅     |

---

## Key Files for Review

### Service Layer (already implemented)

- `server/src/services/section-content.service.ts` - 64 tests passing
- `server/src/adapters/prisma/section-content.repository.ts` - 41 tests passing

### Legacy Code to Replace

- `server/src/routes/internal-agent.routes.ts` lines 1089-1616 - 8 endpoints still using JSON columns

### Repository to Update

- `server/src/adapters/prisma/tenant.repository.ts` - `findBySlugPublic()`, `findBySlugForPreview()`, `findByDomainPublic()` still SELECT landingPageConfig

### Schema to Modify

- `server/prisma/schema.prisma` lines 98-101 - 3 columns to drop from Tenant model

---

## Critical Gaps Identified (SpecFlow Review)

### Gap 1: Response Format Mismatch ⚠️ HIGH RISK

**Problem:** Service methods return different field names than legacy endpoints. Agent tools expect legacy format.

| Legacy Response | Service Response          | Agent Tool Expects |
| --------------- | ------------------------- | ------------------ |
| `section`       | `content`                 | `section`          |
| `page`          | `pageName`                | `page`             |
| `index`         | (calculated from `order`) | `index`            |
| `type`          | `sectionType`             | `type`             |

**Solution in Plan:** Create `adaptPageStructureResponse()` and `adaptSectionContentResponse()` adapter functions in routes.

### Gap 2: Public Routes Need Landing Page Data

**Problem:** `findBySlugPublic()` and `findByDomainPublic()` merge `landingPageConfig` into `branding.landingPage`. After dropping columns, this field disappears.

**Solution in Plan:** Frontend already uses `/sections` API from Phase 4. Stop populating `branding.landingPage`, verify no consumers depend on it.

### Gap 3: togglePage Edge Cases

**Problem:** Service doesn't have `togglePage` method, and proposed implementation doesn't handle:

- Page with NO sections (0 rows updated = no effect)
- Home page constraint enforcement
- Determining page visibility on READ

**Solution in Plan:** Enhanced `togglePage()` implementation that:

- Throws ValidationError when disabling home page
- Creates placeholder section when toggling empty page
- Adds `isPageEnabled()` helper for READ operations

### Gap 4: New Tenant Bootstrap

**Problem:** Agent calls `/storefront/structure` on new tenant with no SectionContent rows → returns empty array → agent tools fail.

**Solution in Plan:** Add `ensureDefaultSections(tenantId)` method that bootstraps DEFAULT_PAGES_CONFIG sections when tenant has none.

---

## Implementation Order (8 Steps)

```
Step 1: Add new service methods (Gap fixes)
        - togglePage() with edge case handling
        - ensureDefaultSections() for new tenants
        - isPageEnabled() helper
        - Add comprehensive tests
              ↓
Step 2: Add response adapter functions
        - adaptPageStructureResponse()
        - adaptSectionContentResponse()
        - Type definitions for legacy response formats
              ↓
Step 3: Migrate internal-agent.routes.ts endpoints
        - Replace JSON reads/writes with service calls
        - Use adapter functions to maintain response format
        - Call ensureDefaultSections() in /structure endpoint
              ↓
Step 4: Verify agent tools work
        - npm test
        - Manual verification with agent chat
        - Test new tenant bootstrap scenario
              ↓
Step 5: Update tenant.repository.ts
        - Remove landingPageConfig from SELECT queries
        - Stop merging into branding.landingPage
        - Delete helper methods
        - Update UpdateTenantInput interface
              ↓
Step 6: Clean build verification
        - rm -rf server/dist && npm run typecheck
        - Fix any orphan imports
              ↓
Step 7: Create Prisma migration
        - npx prisma migrate dev --name drop_landing_page_columns
              ↓
Step 8: Final verification
        - npm run typecheck
        - npm test
        - grep verification script
        - E2E test with agent chat
```

---

## Endpoints Being Migrated

| Endpoint                       | Current                                    | After                                                 |
| ------------------------------ | ------------------------------------------ | ----------------------------------------------------- |
| `/storefront/structure`        | Reads `tenant.landingPageConfigDraft` JSON | `sectionContentService.getPageStructure()` + adapter  |
| `/storefront/section`          | Extracts section from JSON                 | `sectionContentService.getSectionContent()` + adapter |
| `/storefront/update-section`   | Mutates draft JSON                         | `sectionContentService.updateSection()`               |
| `/storefront/add-section`      | Appends to draft JSON                      | `sectionContentService.addSection()`                  |
| `/storefront/remove-section`   | Splices from draft JSON                    | `sectionContentService.removeSection()`               |
| `/storefront/reorder-sections` | Reorders draft JSON                        | `sectionContentService.reorderSection()`              |
| `/storefront/toggle-page`      | Sets `page.enabled` in JSON                | `sectionContentService.togglePage()` (NEW)            |
| `/storefront/preview`          | Checks `!!tenant.landingPageConfigDraft`   | `sectionContentService.hasDraft()`                    |

**Note:** `/storefront/update-branding` stays as-is - uses `tenant.branding`, not landingPageConfig.

---

## Risk Assessment

| Risk                                              | Likelihood | Impact | Mitigation                                  |
| ------------------------------------------------- | ---------- | ------ | ------------------------------------------- |
| Agent tools break due to response format mismatch | **High**   | High   | Adapter functions (Gap 1 fix)               |
| New tenant bootstrap fails                        | Medium     | High   | ensureDefaultSections() (Gap 4 fix)         |
| togglePage edge cases                             | Medium     | Medium | Enhanced implementation (Gap 3 fix)         |
| Public routes break                               | Medium     | Medium | Frontend already uses /sections API (Gap 2) |
| Orphan imports cause CI failure                   | Medium     | Low    | Clean build before commit (Pitfall #87)     |

**Overall Risk:** Medium → Low (with gap fixes)

---

## Success Criteria

### Service Layer

- [ ] `togglePage()` method with edge case handling
- [ ] `ensureDefaultSections()` method for bootstrap
- [ ] `isPageEnabled()` helper
- [ ] 10+ new tests

### Response Format Compatibility

- [ ] `adaptPageStructureResponse()` adapter
- [ ] `adaptSectionContentResponse()` adapter
- [ ] Agent tools receive same response schema

### Route Migration

- [ ] All 8 endpoints migrated
- [ ] `/storefront/structure` calls `ensureDefaultSections()` first

### Repository Cleanup

- [ ] No landingPageConfig references
- [ ] `branding.landingPage` no longer populated
- [ ] Helper methods deleted

### Schema Migration

- [ ] 3 columns dropped from Tenant
- [ ] Migration runs cleanly

### Verification

- [ ] Clean build passes
- [ ] All tests pass
- [ ] grep returns zero matches
- [ ] E2E: Agent can edit sections on new tenant

---

## Key Code Patterns

### Multi-Tenant Security (CRITICAL)

```typescript
// ALL queries MUST include tenantId
const sections = await prisma.sectionContent.findMany({
  where: { tenantId, isDraft: true }, // ← tenantId FIRST
});
```

### T3 Trust Tier (Publish/Discard)

```typescript
// T3 actions require explicit confirmation
if (!confirmationReceived) {
  return { requiresConfirmation: true, message: 'Publish this section?' };
}
```

### Pitfall #52 - Tool State Return

```typescript
// Agent tools MUST return hasDraft for context
return {
  success: true,
  hasDraft: true, // ← CRITICAL: Agent loses context without this
  visibility: 'draft',
  message: 'Section updated in draft.',
};
```

---

## Questions for Reviewers

**Remember: No real users. Challenge any complexity that exists for "transition safety."**

1. **Adapter Functions - Necessary or Over-Engineering?**
   The plan proposes adapter functions to maintain backward compatibility with agent tools. But with no users, should we instead just update the agent tools to expect the new response format? Is maintaining the old format adding unnecessary code?

2. **togglePage Design:** Is setting `visible: false` on all sections the right way to "disable" a page, or is this over-complicating things? Could we just delete the sections when a page is disabled (simpler, since no user data)?

3. **Bootstrap Timing:** Should `ensureDefaultSections()` be called on every `/storefront/structure` request, or moved to tenant provisioning? Or is this even needed - could we just let the service return empty arrays and handle in the agent?

4. **Legacy Response Format Types:** The plan creates type definitions for "legacy response formats." Is this adding cruft we'll never remove, or genuinely useful for clarity?

5. **Are we deleting enough?** With no users, is there legacy code in the plan that we're preserving unnecessarily? Challenge anything that looks like it exists for "safety."

---

## Files to Create/Modify

### Create

- None (all new code goes in existing files)

### Modify

| File                                                  | Changes                                                          |
| ----------------------------------------------------- | ---------------------------------------------------------------- |
| `server/src/services/section-content.service.ts`      | Add `togglePage()`, `ensureDefaultSections()`, `isPageEnabled()` |
| `server/src/services/section-content.service.test.ts` | Add 10+ tests for new methods                                    |
| `server/src/routes/internal-agent.routes.ts`          | Replace 8 endpoints, add adapter functions                       |
| `server/src/adapters/prisma/tenant.repository.ts`     | Remove landingPageConfig queries, delete helpers                 |
| `server/prisma/schema.prisma`                         | Remove 3 columns from Tenant                                     |
| `CLAUDE.md`                                           | Update "Storefront Storage" section                              |

### Delete

None - all legacy files already deleted in Phase 5.1

---

## Reference Documents

- Parent plan: `docs/plans/2026-02-02-refactor-section-content-migration-plan.md`
- Brainstorm: `docs/brainstorms/2026-01-30-semantic-storefront-architecture-brainstorm.md`
- CLAUDE.md "Storefront Storage (Phase 5)" section
- Agent tools: `server/src/agent-v2/deploy/tenant/src/tools/`
