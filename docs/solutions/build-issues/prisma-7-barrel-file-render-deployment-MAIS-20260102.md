---
title: Prisma 7 Build Failure on Render - Barrel File Solution
slug: prisma-7-barrel-file-render-deployment
category: Build Issues
tags:
  - prisma
  - build-failure
  - render
  - deployment
  - generated-code
severity: P0
component: Prisma 7, TypeScript build
symptoms:
  - Build fails on Render with `Cannot find module './generated/prisma'`
  - Module import resolves to `client.ts` instead of `index.ts`
  - Local builds succeed but production deployment fails
  - Works fine with Prisma 6, broken after upgrade to 7
---

## Summary

Prisma 7 changed the entry point from `index.ts` to `client.ts` in the generated client. On Render, the build fails with "Cannot find module './generated/prisma'" because the old barrel file (`index.ts`) is not automatically recreated after `prisma generate`.

**Root Cause:** Post-build hooks don't automatically run on Render. The `prisma generate` command creates only `client.ts`, but our codebase imports from `./generated/prisma` (implicitly looking for `index.ts`).

**Solution:** Post-generate script that creates a barrel file after each `prisma generate` command, ensuring backward compatibility.

## Technical Details

### Before (Prisma 6)

```
server/src/generated/prisma/
├── index.ts          # Main entry point (auto-generated)
├── client.ts         # PrismaClient class
└── schema.prisma
```

Imports worked fine:

```typescript
import { PrismaClient } from '../generated/prisma'; // Resolves to index.ts
```

### After (Prisma 7 without fix)

```
server/src/generated/prisma/
├── client.ts         # Main entry point (auto-generated)
├── schema.prisma
├── query.ts
└── runtime/
```

Breaking change:

```typescript
import { PrismaClient } from '../generated/prisma'; // ❌ Looks for index.ts, doesn't exist!
```

### After (Prisma 7 with barrel file)

```
server/src/generated/prisma/
├── index.ts          # ✅ Barrel file (re-exports from client.ts)
├── client.ts         # Main entry point (auto-generated)
└── ...
```

Imports work again:

```typescript
import { PrismaClient } from '../generated/prisma'; // ✅ Resolves to index.ts
```

## Implementation

### 1. Create Post-Generate Script

**File:** `server/scripts/prisma-postgenerate.js`

```javascript
#!/usr/bin/env node
/**
 * Prisma 7 Post-Generate Script
 *
 * Creates a barrel file (index.ts) in the generated prisma directory
 * to maintain backward compatibility with Prisma 6 import patterns.
 *
 * In Prisma 7, the entry point changed from index.ts to client.ts.
 * This script recreates the index.ts after each `prisma generate`.
 */

import { writeFileSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const generatedDir = join(__dirname, '../src/generated/prisma');
const indexPath = join(generatedDir, 'index.ts');

const barrelContent = `/**
 * Prisma 7 Barrel File - Backward Compatibility Layer
 *
 * AUTO-GENERATED by scripts/prisma-postgenerate.js
 * DO NOT EDIT MANUALLY - This file is recreated after each prisma generate.
 *
 * In Prisma 7, the main entry point changed from index.ts to client.ts.
 * This barrel file re-exports everything from client.ts to maintain
 * backward compatibility with existing imports.
 */

export * from './client';
`;

try {
  writeFileSync(indexPath, barrelContent, 'utf-8');
  console.log('✅ Created Prisma barrel file: src/generated/prisma/index.ts');
} catch (error) {
  console.error('❌ Failed to create Prisma barrel file:', error);
  process.exit(1);
}
```

### 2. Update package.json Scripts

**File:** `server/package.json`

```json
{
  "scripts": {
    "prisma:generate": "prisma generate && node scripts/prisma-postgenerate.js",
    "prisma:postgenerate": "node scripts/prisma-postgenerate.js",
    "build": "npm run prisma:generate && tsc -b"
  }
}
```

The key insight: `prisma:generate` now automatically runs the post-generate script.

### 3. Update Deployment Configuration

**File:** `render.yaml`

For the main API service:

```yaml
buildCommand: npm ci && npm run build --workspace=@macon/contracts && npm run build --workspace=@macon/shared && npm run build --workspace=@macon/api
envVars:
  - key: DATABASE_URL
    sync: false
  - key: DIRECT_URL
    sync: false
```

The `npm run build` command automatically calls `prisma:generate`, which includes the post-generate script.

For the cron job (agent evaluation):

```yaml
buildCommand: npm ci && npm run build --workspace=@macon/contracts && npm run build --workspace=@macon/shared && cd server && npm run prisma:generate
startCommand: cd server && npx tsx scripts/run-eval-batch.ts
envVars:
  - key: DATABASE_URL
    sync: false
  - key: DIRECT_URL
    sync: false
```

The explicit `npm run prisma:generate` ensures the barrel file is created before the cron job starts.

**CRITICAL:** Both `DATABASE_URL` and `DIRECT_URL` must be set for Prisma 7:

- `DATABASE_URL` = Session Pooler (port 5432, pgbouncer mode) - used at runtime
- `DIRECT_URL` = Transaction Pooler (port 6543, no pgbouncer) - used during `prisma generate` for schema introspection

Without `DIRECT_URL`, `prisma generate` fails with:

```
PrismaConfigEnvError: Cannot resolve environment variable: DIRECT_URL
```

## How It Works

1. **Build triggers:** Either `npm run prisma:generate` or `npm run build` is called
2. **Prisma generates:** `prisma generate` creates `client.ts` and other files
3. **Post-generate runs:** `node scripts/prisma-postgenerate.js` creates `index.ts`
4. **Barrel file exports:** `index.ts` re-exports everything from `client.ts`
5. **Imports resolve:** `import { PrismaClient } from '../generated/prisma'` now finds `index.ts`

## Why This Approach

### Why not rename imports?

- Would require changes across 50+ files in the codebase
- Error-prone and could cause subtle bugs
- Doesn't solve the core issue of compatibility

### Why a barrel file instead of modifying Prisma config?

- Prisma 7 doesn't offer a config option to change the output file name
- Post-generate hooks are the official pattern for customization
- Barrel files are a standard TypeScript pattern

### Why not commit the barrel file to git?

- It's generated code, not source code
- Changes on every `prisma generate` (unnecessary git noise)
- The script ensures it's always in sync with the generated client

## Verification

After applying the fix, verify the build works:

```bash
# Clean and rebuild
cd server
rm -rf src/generated/prisma/index.ts
npm run prisma:generate
ls src/generated/prisma/index.ts  # Should exist now

# Verify imports still work
npm run typecheck
```

On Render, the build log should show:

```
✅ Created Prisma barrel file: src/generated/prisma/index.ts
```

## Migration Checklist

- [x] Created `server/scripts/prisma-postgenerate.js`
- [x] Updated `server/package.json` with `prisma:generate` and `prisma:postgenerate` scripts
- [x] Updated `server/package.json` build command to use `prisma:generate`
- [x] Updated `render.yaml` API buildCommand to include complete build pipeline
- [x] Updated `render.yaml` cron job buildCommand with explicit `prisma:generate`
- [x] Verified barrel file is created on fresh builds
- [x] Verified TypeScript compilation succeeds
- [x] Tested on Render deployment

## References

- **Prisma 7 Documentation:** https://www.prisma.io/docs/guides/upgrade-guides/upgrading-to-prisma-6
- **Post-Generate Hooks:** https://www.prisma.io/docs/orm/reference/command-reference#generate
- **Barrel Files Pattern:** https://typescript-eslint.io/docs/rules/no-restricted-imports/#barrel-files

## Related Issues

- Issue: Prisma 7 Build Failure on Render (P0)
- Related: `docs/solutions/database-issues/prisma-7-json-type-breaking-changes-MAIS-20260102.md`
