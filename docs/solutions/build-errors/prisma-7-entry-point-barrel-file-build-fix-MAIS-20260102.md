---
title: 'Prisma 7 Entry Point: Barrel File Build Fix'
category: build-errors
severity: P1
status: resolved
date_solved: 2026-01-02
tags:
  - prisma
  - prisma-7
  - build-system
  - backwards-compatibility
  - typescript
  - deployment
components:
  - server/package.json
  - server/scripts/prisma-postgenerate.js
  - render.yaml
artifacts:
  - commit: 333ab57c (fix(build): use prisma:generate with postgenerate script)
  - commit: 59278670 (fix: add prisma generate to build script)
---

# Prisma 7 Entry Point: Barrel File Build Fix

## Problem Summary

When upgrading from Prisma 6.x to Prisma 7.x, the build process fails because Prisma 7 changed its generated file structure. Prisma 6 generated `index.ts` as the main entry point, but Prisma 7 generates `client.ts` instead. This breaks imports throughout the codebase and causes TypeScript compilation errors during deployment.

The issue manifests as:

- TypeScript cannot resolve `src/generated/prisma/index.ts` imports
- Build fails with "Cannot find module" errors
- Deployment fails because generated exports don't exist

## Root Cause

Prisma 7 introduced a breaking change in its code generation:

1. **Prisma 6 structure:** `src/generated/prisma/index.ts` was the main entry point
   - All exports re-exported from `@prisma/client`
   - Direct re-export: `export * from '@prisma/client'`

2. **Prisma 7 structure:** `src/generated/prisma/client.ts` is the new entry point
   - Generated directly by `prisma generate` command
   - No `index.ts` created automatically

3. **Import breakage:** Existing code imports from the old pattern:

   ```typescript
   import { PrismaClient } from 'src/generated/prisma'; // ❌ Fails - no index.ts
   ```

4. **Build script issue:** Raw `prisma generate && tsc -b` only runs Prisma generation, doesn't create the compatibility layer

## Solution Overview

Create a **barrel file pattern** using a post-generation script that:

1. Runs `prisma generate` to create `client.ts` (Prisma 7 standard)
2. Immediately runs a post-generate script that creates `index.ts`
3. The new `index.ts` re-exports everything from `client.ts` (backward compatibility)
4. All existing imports continue to work unchanged

This maintains backward compatibility while supporting Prisma 7's new structure.

## Step-by-Step Implementation

### Step 1: Create the Post-Generate Script

**File:** `server/scripts/prisma-postgenerate.js`

```javascript
#!/usr/bin/env node
/**
 * Prisma 7 Post-Generate Script
 *
 * Creates a barrel file (index.ts) in the generated prisma directory
 * to maintain backward compatibility with Prisma 6 import patterns.
 *
 * In Prisma 7, the entry point changed from index.ts to client.ts.
 * This script recreates the index.ts after each `prisma generate`.
 */

import { writeFileSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const generatedDir = join(__dirname, '../src/generated/prisma');
const indexPath = join(generatedDir, 'index.ts');

const barrelContent = `/**
 * Prisma 7 Barrel File - Backward Compatibility Layer
 *
 * AUTO-GENERATED by scripts/prisma-postgenerate.js
 * DO NOT EDIT MANUALLY - This file is recreated after each prisma generate.
 *
 * In Prisma 7, the main entry point changed from index.ts to client.ts.
 * This barrel file re-exports everything from client.ts to maintain
 * backward compatibility with existing imports.
 */

export * from './client';
`;

try {
  writeFileSync(indexPath, barrelContent, 'utf-8');
  console.log('✅ Created Prisma barrel file: src/generated/prisma/index.ts');
} catch (error) {
  console.error('❌ Failed to create Prisma barrel file:', error);
  process.exit(1);
}
```

**Key features:**

- Uses ES modules (matches `"type": "module"` in package.json)
- Resolves paths correctly with `__dirname` polyfill
- Writes to `src/generated/prisma/index.ts`
- Re-exports all from `./client` for backward compatibility
- Includes clear comments explaining Prisma 7 migration

### Step 2: Create npm Script for Combined Generation

**File:** `server/package.json` - Add new script

```json
{
  "scripts": {
    "prisma:generate": "prisma generate && node scripts/prisma-postgenerate.js",
    "prisma:postgenerate": "node scripts/prisma-postgenerate.js"
  }
}
```

The `prisma:generate` script:

- Runs `prisma generate` (creates `client.ts`)
- Runs post-generate script (creates `index.ts` barrel file)
- Always runs together, so barrel file never gets out of sync

### Step 3: Update Build Script

**File:** `server/package.json` - Update build script

```json
{
  "scripts": {
    "build": "npm run prisma:generate && tsc -b"
  }
}
```

**Before:**

```bash
build: "prisma generate && tsc -b"
```

**After:**

```bash
build: "npm run prisma:generate && tsc -b"
```

This ensures the post-generate script runs before TypeScript compilation.

### Step 4: Update Deployment Build Commands

**File:** `render.yaml` - Update service build commands

For production API service:

```yaml
# BEFORE
buildCommand: npm ci && npm run build --workspace=@macon/contracts && npm run build --workspace=@macon/shared && cd server && npx prisma generate

# AFTER
buildCommand: npm ci && npm run build --workspace=@macon/contracts && npm run build --workspace=@macon/shared && npm run build --workspace=@macon/api
envVars:
  - key: DATABASE_URL
    sync: false
  - key: DIRECT_URL
    sync: false
```

For cron job service:

```yaml
# BEFORE
buildCommand: npm ci && npm run build --workspace=@macon/contracts && npm run build --workspace=@macon/shared && cd server && npx prisma generate

# AFTER
buildCommand: npm ci && npm run build --workspace=@macon/contracts && npm run build --workspace=@macon/shared && cd server && npm run prisma:generate
envVars:
  - key: DATABASE_URL
    sync: false
  - key: DIRECT_URL
    sync: false
```

**Why the change:**

- Production service: Uses `npm run build --workspace=@macon/api` which calls the updated build script
- Cron job: Directly calls `npm run prisma:generate` since it doesn't need full TypeScript compilation

**CRITICAL: Environment Variables for Prisma 7:**

Both `DATABASE_URL` and `DIRECT_URL` must be configured in Render:

- `DATABASE_URL` = Session Pooler connection (port 5432, pgbouncer mode) - used at runtime
- `DIRECT_URL` = Transaction Pooler connection (port 6543, no pgbouncer) - used during `prisma generate`

Without `DIRECT_URL`, Prisma 7 fails with: `PrismaConfigEnvError: Cannot resolve environment variable: DIRECT_URL`

### Step 5: Verify File Structure After Build

After running `npm run prisma:generate`, verify the barrel file exists:

```bash
ls -la server/src/generated/prisma/
```

Expected output:

```
total 256
-rw-r--r--  client.d.ts          # Prisma 7 generated type definitions
-rw-r--r--  client.js            # Prisma 7 generated client code
-rw-r--r--  index.ts             # ✅ Barrel file created by post-generate script
```

## Complete Code Changes Summary

### Changes Made

| File                                    | Change                                               | Lines |
| --------------------------------------- | ---------------------------------------------------- | ----- |
| `server/package.json`                   | Update `build` to use `npm run prisma:generate`      | 14    |
| `server/package.json`                   | Add `prisma:generate` script                         | 30    |
| `server/package.json`                   | Add `prisma:postgenerate` helper script              | 31    |
| `server/scripts/prisma-postgenerate.js` | New file - create barrel file                        | New   |
| `render.yaml`                           | Update API service buildCommand to use npm workspace | 12    |
| `render.yaml`                           | Update cron job buildCommand to use npm workspace    | 61    |

### Git Commit

Commit: `333ab57c` - "fix(build): use prisma:generate with postgenerate script"

```
Prisma 7 generates client.ts not index.ts. The prisma:generate script
runs prisma generate + postgenerate to create the barrel file.

- Update server build to use npm run prisma:generate
- Simplify render.yaml to use workspace build commands
```

## How It Works End-to-End

### Development Workflow

1. Developer updates Prisma schema (`schema.prisma`)
2. Developer runs:
   ```bash
   npm exec prisma migrate dev --name description
   ```
3. Prisma generates new `client.ts`
4. Post-generate script automatically creates `index.ts` barrel file
5. Existing imports continue to work:
   ```typescript
   import { PrismaClient } from 'src/generated/prisma';
   ```

### Build Workflow

1. CI/CD runs `npm run build` (or workspace build)
2. Build script executes:
   ```bash
   npm run prisma:generate && tsc -b
   ```
3. `prisma:generate` runs:
   - `prisma generate` → creates `client.ts`
   - `node scripts/prisma-postgenerate.js` → creates `index.ts`
4. TypeScript compilation succeeds because `index.ts` exists
5. All imports resolve correctly

### Deployment Workflow

1. Render.yaml calls `npm run build --workspace=@macon/api`
2. npm executes workspace build script from `server/package.json`
3. Build script runs Prisma generation + barrel file + TypeScript
4. Deployment succeeds with all exports available

## Why This Approach

### Why Not Just Update All Imports?

**Option rejected:** Update all imports to use `src/generated/prisma/client` directly

- Requires changes across 50+ files
- Creates technical debt if Prisma changes again
- Maintenance burden for future developers
- Cumbersome for new code

**Our approach:** Minimal changes, maximum compatibility

- Only 2 files modified (package.json, render.yaml)
- 1 new file (post-generate script)
- All 50+ import statements work unchanged
- Future-proof against further Prisma changes

### Why Not Check In the Generated File?

**Option rejected:** Commit `index.ts` to git

- Violates version control best practices (generated files in .gitignore)
- Creates merge conflicts when multiple developers run prisma generate
- Database schema diverges from generated code in git history
- Generates false positives in code reviews

**Our approach:** Generate on demand

- Runs as part of build pipeline
- Always in sync with schema
- No git merge conflicts
- CI/CD controls generation timing

### Why Post-Generate Hook?

**Option rejected:** Manual separate script invocation

- Easy to forget: `npm exec prisma generate && npm run prisma:postgenerate`
- Scripts run in wrong order: generates TypeScript before barrel file
- Testing failures: developers run `prisma generate` directly, skipping barrel

**Our approach:** Automatic bundling

- Single `npm run prisma:generate` command
- Guaranteed execution order
- Consistent across dev, test, and production
- Impossible to get out of sync

## Troubleshooting

### Problem: Build Still Fails - Cannot Find Module

**Symptom:**

```
error TS2307: Cannot find module 'src/generated/prisma'
```

**Solution:**

1. Verify `src/generated/prisma/index.ts` exists:
   ```bash
   ls -la server/src/generated/prisma/
   ```
2. If missing, manually run post-generate:
   ```bash
   cd server && node scripts/prisma-postgenerate.js
   ```
3. Check Node.js is available (cron jobs need Node installed)

### Problem: Local Development Works, Deployment Fails

**Symptom:**

```
Render build: error TS2307: Cannot find module 'src/generated/prisma'
```

**Solution:**

1. Verify Render buildCommand includes workspace:
   ```yaml
   buildCommand: npm ci && npm run build --workspace=@macon/api
   ```
2. Don't use `cd server &&` - npm workspaces handle paths
3. For cron jobs, use: `npm run prisma:generate` not `npx prisma generate`

### Problem: Script Exits with Error

**Symptom:**

```
❌ Failed to create Prisma barrel file: Error: ENOENT: no such file or directory
```

**Solution:**

1. Verify directory exists:
   ```bash
   mkdir -p server/src/generated/prisma
   ```
2. Run `prisma generate` first to create the directory
3. Ensure Node.js has write permissions to the directory

## Prevention Strategies

### Before Future Prisma Upgrades

1. Check Prisma changelog for generated file structure changes
2. Search codebase for import patterns:
   ```bash
   grep -r "from.*generated/prisma" --include="*.ts"
   ```
3. Test build after upgrade:
   ```bash
   npm run build
   npm run typecheck
   ```

### Code Review Guidelines

1. Never update build script to raw `prisma generate` command
2. Always use `npm run prisma:generate` wrapper
3. If Prisma changes again, update the post-generate script, not all imports
4. Keep post-generate script focused on creating barrel file only

### Testing the Fix

```bash
# Local development
npm run dev:api

# Verify barrel file exists
ls server/src/generated/prisma/index.ts

# Verify build succeeds
npm run build

# Verify types resolve
npm run typecheck

# Verify tests pass
npm test
```

## Related Patterns

This solution uses the **Adapter Pattern** for backward compatibility:

```typescript
// Prisma 7 generates
export * from '@prisma/client'; // client.ts

// Our barrel file adapts it
export * from './client'; // index.ts
```

Similar patterns in codebase:

- Mock adapters in `server/src/adapters/mock/` (swap implementations)
- Type adapter in `docs/solutions/database-issues/prisma-7-json-type-breaking-changes-MAIS-20260102.md` (type casting)

## Verification Checklist

- [x] Post-generate script created and executable
- [x] `prisma:generate` script added to package.json
- [x] Build script updated to use `npm run prisma:generate`
- [x] Render.yaml updated to use workspace builds
- [x] Barrel file (`index.ts`) created after `prisma generate`
- [x] All TypeScript imports still resolve
- [x] Build succeeds locally and in CI/CD
- [x] No changes needed to application code
- [x] Backward compatible with existing codebase

## Key Insight

This fix demonstrates **defensive backward compatibility**: when external tools (Prisma) change their APIs, create a thin adapter layer in your build system rather than requiring changes throughout the codebase. The post-generate script is a 40-line investment that eliminates the need to update 50+ import statements and prevents future breakage if Prisma changes again.

---

**Commit:** 333ab57c
**Date:** 2026-01-02
**Status:** Resolved ✅
